const API_BASE = 'http://localhost:8081/api';
let currentUser = null;
let authToken = null;

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    checkAuth();
    setupEventListeners();
});

function setupEventListeners() {
    document.getElementById('loginForm').addEventListener('submit', handleLogin);
    document.getElementById('createUserForm')?.addEventListener('submit', handleCreateUser);
    document.getElementById('createProviderForm')?.addEventListener('submit', handleCreateProvider);
    document.getElementById('createInvoiceForm')?.addEventListener('submit', handleCreateInvoice);
    document.getElementById('createInvoiceFormSuper')?.addEventListener('submit', handleCreateInvoiceSuper);
    document.getElementById('updateInvoiceForm')?.addEventListener('submit', handleUpdateInvoice);
    document.getElementById('updateInvoiceFormSuper')?.addEventListener('submit', handleUpdateInvoiceSuper);
    document.getElementById('nlQueryForm')?.addEventListener('submit', handleNLQuery);
}

function checkAuth() {
    const token = localStorage.getItem('authToken');
    const user = localStorage.getItem('currentUser');

    if (token && user) {
        authToken = token;
        currentUser = JSON.parse(user);
        showDashboard();
    } else {
        showPage('loginPage');
    }
}

async function handleLogin(e) {
    e.preventDefault();
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;

    try {
        const response = await fetch(`${API_BASE}/auth/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || 'Login failed');
        }

        const data = await response.json();
        authToken = data.token;
        currentUser = data;

        localStorage.setItem('authToken', authToken);
        localStorage.setItem('currentUser', JSON.stringify(currentUser));

        showDashboard();
    } catch (error) {
        document.getElementById('loginError').textContent = error.message;
    }
}

function logout() {
    localStorage.removeItem('authToken');
    localStorage.removeItem('currentUser');
    authToken = null;
    currentUser = null;
    showPage('loginPage');
}

function showPage(pageId) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');
}

function showDashboard() {
    showPage('dashboardPage');

    let userInfoText = `${currentUser.name} (${currentUser.role})`;
    if (currentUser.providerName) {
        userInfoText += ` - ${currentUser.providerName}`;
    }
    document.getElementById('userInfo').textContent = userInfoText;

    // Hide all dashboards
    document.querySelectorAll('.dashboard').forEach(d => d.style.display = 'none');

    // Show appropriate dashboard
    switch(currentUser.role) {
        case 'Admin':
            document.getElementById('adminDashboard').style.display = 'block';
            loadProviders();
            break;
        case 'Customer':
            document.getElementById('customerDashboard').style.display = 'block';
            loadCustomerInvoices();
            break;
        case 'Invoice_Creator':
            document.getElementById('creatorDashboard').style.display = 'block';
            loadCreatorInvoices();
            break;
        case 'Super_Creator':
            document.getElementById('superCreatorDashboard').style.display = 'block';
            loadSuperCreatorInvoices();
            break;
        case 'Auditor':
            document.getElementById('auditorDashboard').style.display = 'block';
            loadAuditorInvoices();
            break;
    }
}

function showTab(tabName) {
    // Remove active from all tabs
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

    // Add active to selected tab
    event.target.classList.add('active');
    document.getElementById(tabName + 'Tab').classList.add('active');

    // Load data for specific tabs
    if (tabName === 'logs') loadAuditLogs();
}

async function apiCall(endpoint, options = {}) {
    const defaultOptions = {
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
        }
    };

    const response = await fetch(`${API_BASE}${endpoint}`, {
        ...defaultOptions,
        ...options,
        headers: { ...defaultOptions.headers, ...options.headers }
    });

    if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || 'Request failed');
    }

    return response.json();
}

// Admin Functions
async function handleCreateUser(e) {
    e.preventDefault();
    try {
        const data = {
            providerId: parseInt(document.getElementById('userProviderId').value),
            name: document.getElementById('userName').value,
            email: document.getElementById('userEmail').value,
            address: document.getElementById('userAddress').value,
            password: document.getElementById('userPassword').value,
            phoneNumber: document.getElementById('userPhone').value
        };

        await apiCall('/admin/users', { method: 'POST', body: JSON.stringify(data) });
        alert('Customer created successfully!');
        e.target.reset();
        loadUsers();
    } catch (error) {
        alert('Error: ' + error.message);
    }
}



async function handleCreateProvider(e) {
    e.preventDefault();
    try {
        const data = {
            name: document.getElementById('providerName').value,
            city: document.getElementById('providerCity').value,
            email: document.getElementById('providerEmail').value,
            phoneNumber: document.getElementById('providerPhone').value,
            currentKwhPrice: parseFloat(document.getElementById('providerPrice').value)
        };

        await apiCall('/admin/providers', { method: 'POST', body: JSON.stringify(data) });
        alert('Provider created successfully!');
        e.target.reset();
        loadProviders();
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function loadProviders() {
    try {
        // Get only the provider that the admin belongs to
        if (!currentUser.providerId) {
            document.getElementById('providersList').innerHTML = '<p>No provider assigned to this admin.</p>';
            return;
        }

        const provider = await apiCall(`/admin/providers/${currentUser.providerId}`);
        const html = `
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>City</th>
                        <th>Email</th>
                        <th>Current kWh Price</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>${provider.providerId}</td>
                        <td>${provider.name}</td>
                        <td>${provider.city}</td>
                        <td>${provider.email}</td>
                        <td>${provider.currentKwhPrice}</td>
                        <td>
                            <button class="btn btn-primary" onclick="updatePrice(${provider.providerId})">Update Price</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        `;
        document.getElementById('providersList').innerHTML = html;
    } catch (error) {
        console.error('Error loading providers:', error);
        document.getElementById('providersList').innerHTML = '<p style="color: red;">Error loading provider information.</p>';
    }
}

async function updatePrice(providerId) {
    const newPrice = prompt('Enter new kWh price:');
    if (newPrice) {
        try {
            await apiCall(`/admin/providers/${providerId}/price`, {
                method: 'PUT',
                body: JSON.stringify({ newKwhPrice: parseFloat(newPrice) })
            });
            alert('Price updated successfully!');
            loadProviders();
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }
}

// Invoice Functions
async function handleCreateInvoice(e) {
    e.preventDefault();
    try {
        const data = {
            customerId: parseInt(document.getElementById('invoiceCustomerId').value),
            kwhConsumed: parseFloat(document.getElementById('invoiceKwh').value),
            issueDate: document.getElementById('invoiceIssueDate').value,
            dueDate: document.getElementById('invoiceDueDate').value
        };

        await apiCall(`/invoices?creatorUserId=${currentUser.userId}`, { method: 'POST', body: JSON.stringify(data) });
        alert('Invoice created successfully!');
        e.target.reset();
        loadCreatorInvoices();
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function handleCreateInvoiceSuper(e) {
    e.preventDefault();
    try {
        const data = {
            customerId: parseInt(document.getElementById('invoiceCustomerIdSuper').value),
            kwhConsumed: parseFloat(document.getElementById('invoiceKwhSuper').value),
            issueDate: document.getElementById('invoiceIssueDateSuper').value,
            dueDate: document.getElementById('invoiceDueDateSuper').value
        };

        await apiCall(`/invoices?creatorUserId=${currentUser.userId}`, { method: 'POST', body: JSON.stringify(data) });
        alert('Invoice created successfully!');
        e.target.reset();
        loadSuperCreatorInvoices();
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function loadCustomerInvoices() {
    try {
        console.log('Loading customer invoices for userId:', currentUser.userId);
        const invoices = await apiCall(`/invoices/my-invoices?customerId=${currentUser.userId}`);
        console.log('Received invoices:', invoices);
        displayInvoices(invoices, 'customerInvoices');
    } catch (error) {
        console.error('Error loading invoices:', error);
        document.getElementById('customerInvoices').innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
    }
}

async function loadCreatorInvoices() {
    try {
        const invoices = await apiCall(`/invoices/my-created?creatorId=${currentUser.userId}`);
        displayInvoices(invoices, 'creatorInvoices');
    } catch (error) {
        console.error('Error loading invoices:', error);
    }
}

async function loadSuperCreatorInvoices() {
    try {
        const invoices = await apiCall(`/invoices/provider?providerId=${currentUser.providerId}`);
        displayInvoices(invoices, 'superCreatorInvoices');
    } catch (error) {
        console.error('Error loading invoices:', error);
    }
}

async function loadAuditorInvoices() {
    try {
        const invoices = await apiCall(`/audit/invoices?auditorUserId=${currentUser.userId}`);
        displayInvoices(invoices, 'auditorInvoices');
    } catch (error) {
        console.error('Error loading invoices:', error);
    }
}

function displayInvoices(invoices, containerId) {
    console.log('Displaying invoices:', invoices); // Debug log

    if (!invoices || invoices.length === 0) {
        document.getElementById(containerId).innerHTML = '<p>No invoices found.</p>';
        return;
    }

    const statusBadge = (status) => {
        const badges = {
            'Paid': 'badge-success',
            'Pending': 'badge-warning',
            'Overdue': 'badge-danger',
            'Cancelled': 'badge-info'
        };
        return `<span class="badge ${badges[status]}">${status}</span>`;
    };

    // Check if user can edit (Invoice_Creator or Super_Creator)
    const canEdit = currentUser && (currentUser.role === 'Invoice_Creator' || currentUser.role === 'Super_Creator');

    const html = `
        <table>
            <thead>
                <tr>
                    <th>Invoice #</th>
                    <th>Customer</th>
                    <th>Provider</th>
                    <th>Created By</th>
                    <th>kWh</th>
                    <th>Price/kWh</th>
                    <th>Total Amount</th>
                    <th>Issue Date</th>
                    <th>Due Date</th>
                    <th>Payment Date</th>
                    <th>Status</th>
                    ${canEdit ? '<th>Actions</th>' : ''}
                </tr>
            </thead>
            <tbody>
                ${invoices.map(inv => `
                    <tr>
                        <td>${inv.invoiceNumber || 'N/A'}</td>
                        <td>${inv.customer?.name || 'N/A'}</td>
                        <td>${inv.provider?.name || 'N/A'}</td>
                        <td>${inv.createdByUser?.name || 'N/A'}</td>
                        <td>${inv.kwhConsumed || 0}</td>
                        <td>${inv.pricing?.kwhPrice || 'N/A'}</td>
                        <td>${inv.totalAmount || 0}</td>
                        <td>${inv.issueDate || 'N/A'}</td>
                        <td>${inv.dueDate || 'N/A'}</td>
                        <td>${inv.paymentDate || '-'}</td>
                        <td>${statusBadge(inv.paymentStatus)}</td>
                        ${canEdit ? `<td><button class="btn btn-sm btn-primary" onclick='openUpdateModal(${JSON.stringify(inv)})'>Edit</button></td>` : ''}
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
    document.getElementById(containerId).innerHTML = html;
}

// Audit Functions
async function loadAuditLogs() {
    try {
        const logs = await apiCall(`/audit/logs?auditorUserId=${currentUser.userId}`);
        const html = `
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Invoice #</th>
                        <th>Action</th>
                        <th>Performed By</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>
                    ${logs.map(log => `
                        <tr>
                            <td>${log.auditId}</td>
                            <td>${log.invoice?.invoiceNumber || 'N/A'}</td>
                            <td><span class="badge badge-info">${log.action}</span></td>
                            <td>${log.performedByUser?.name || 'N/A'}</td>
                            <td>${new Date(log.performedAt).toLocaleString()}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        document.getElementById('auditLogs').innerHTML = html;
    } catch (error) {
        console.error('Error loading audit logs:', error);
    }
}

async function handleNLQuery(e) {
    e.preventDefault();
    const query = document.getElementById('nlQuery').value;

    try {
        const result = await apiCall(`/audit/query?auditorUserId=${currentUser.userId}`, {
            method: 'POST',
            body: JSON.stringify({ query })
        });

        const html = `
            <div class="query-result">
                <h4>Query: ${result.query}</h4>
                <p><strong>Generated SQL:</strong></p>
                <pre>${result.generatedSQL}</pre>
                <p><strong>Results (${result.rowCount} rows):</strong></p>
                <table>
                    <thead>
                        <tr>
                            ${result.results.length > 0 ? Object.keys(result.results[0]).map(key => `<th>${key}</th>`).join('') : ''}
                        </tr>
                    </thead>
                    <tbody>
                        ${result.results.map(row => `
                            <tr>
                                ${Object.values(row).map(val => `<td>${val}</td>`).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
        document.getElementById('queryResults').innerHTML = html;
    } catch (error) {
        document.getElementById('queryResults').innerHTML = `
            <div class="error">Error: ${error.message}</div>
        `;
    }
}

// Update Invoice Functions
function openUpdateModal(invoice) {
    const modalId = currentUser.role === 'Super_Creator' ? 'updateInvoiceModalSuper' : 'updateInvoiceModal';
    const prefix = currentUser.role === 'Super_Creator' ? 'Super' : '';

    document.getElementById(`updateInvoiceId${prefix}`).value = invoice.invoiceId;
    document.getElementById(`updateInvoiceNumber${prefix}`).textContent = invoice.invoiceNumber;
    document.getElementById(`updateKwh${prefix}`).value = invoice.kwhConsumed;
    document.getElementById(`updateDueDate${prefix}`).value = invoice.dueDate;
    document.getElementById(`updatePaymentStatus${prefix}`).value = invoice.paymentStatus;
    document.getElementById(`updatePaymentDate${prefix}`).value = invoice.paymentDate || '';

    document.getElementById(modalId).style.display = 'block';
}

function closeUpdateModal() {
    document.getElementById('updateInvoiceModal').style.display = 'none';
}

function closeUpdateModalSuper() {
    document.getElementById('updateInvoiceModalSuper').style.display = 'none';
}

async function handleUpdateInvoice(e) {
    e.preventDefault();

    try {
        const invoiceId = document.getElementById('updateInvoiceId').value;
        const data = {};

        const kwh = document.getElementById('updateKwh').value;
        const dueDate = document.getElementById('updateDueDate').value;
        const paymentStatus = document.getElementById('updatePaymentStatus').value;
        const paymentDate = document.getElementById('updatePaymentDate').value;

        if (kwh) data.kwhConsumed = parseFloat(kwh);
        if (dueDate) data.dueDate = dueDate;
        if (paymentStatus) data.paymentStatus = paymentStatus;
        if (paymentDate) data.paymentDate = paymentDate;

        await apiCall(`/invoices/${invoiceId}?updaterUserId=${currentUser.userId}`, {
            method: 'PUT',
            body: JSON.stringify(data)
        });

        alert('Invoice updated successfully!');
        closeUpdateModal();
        loadCreatorInvoices();
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function handleUpdateInvoiceSuper(e) {
    e.preventDefault();

    try {
        const invoiceId = document.getElementById('updateInvoiceIdSuper').value;
        const data = {};

        const kwh = document.getElementById('updateKwhSuper').value;
        const dueDate = document.getElementById('updateDueDateSuper').value;
        const paymentStatus = document.getElementById('updatePaymentStatusSuper').value;
        const paymentDate = document.getElementById('updatePaymentDateSuper').value;

        if (kwh) data.kwhConsumed = parseFloat(kwh);
        if (dueDate) data.dueDate = dueDate;
        if (paymentStatus) data.paymentStatus = paymentStatus;
        if (paymentDate) data.paymentDate = paymentDate;

        await apiCall(`/invoices/${invoiceId}?updaterUserId=${currentUser.userId}`, {
            method: 'PUT',
            body: JSON.stringify(data)
        });

        alert('Invoice updated successfully!');
        closeUpdateModalSuper();
        loadSuperCreatorInvoices();
    } catch (error) {
        alert('Error: ' + error.message);
    }
}
